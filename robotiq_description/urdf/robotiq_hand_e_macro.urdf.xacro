<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="gripper_finger">

    <!-- Colour definations-->
    <material name="gray">
      <color rgba="0.7 0.7 0.7 1.0"/>
    </material>
    <material name="dark">
      <color rgba=".1 0.1 0.1 1.0"/>
    </material>

    <!-- Gripper macro hand-e -->
    <xacro:macro name="robotiq_hande" params="
                 prefix parent *origin
                 left_finger_visual:=default left_finger_collision:=default left_finger_scale:=default
                 right_finger_visual:=default right_finger_collision:=default right_finger_scale:=default
                 tcp_z_offset:=0.1325
                 ">
      <xacro:property name="file_path" value="file://$(find robotiq_description)" />
      <xacro:property name="gripper_maximal_stroke" value="0.050" />

      <!-- resolve complex default values -->
      <xacro:if value="${left_finger_visual == 'default'}">
        <xacro:property name="left_finger_visual" value="${file_path}/meshes/visual/hande/left_finger.dae" />
      </xacro:if>
      <xacro:if value="${left_finger_collision == 'default'}">
        <xacro:property name="left_finger_collision" value="${file_path}/meshes/collision/hande/left_finger.stl" />
      </xacro:if>
      <xacro:if value="${left_finger_scale == 'default'}">
        <xacro:property name="left_finger_scale" value="1.0 1.0 1.0" />
      </xacro:if>
      <xacro:if value="${right_finger_visual == 'default'}">
        <xacro:property name="right_finger_visual" value="${file_path}/meshes/visual/hande/right_finger.dae" />
      </xacro:if>
      <xacro:if value="${right_finger_collision == 'default'}">
        <xacro:property name="right_finger_collision" value="${file_path}/meshes/collision/hande/right_finger.stl" />
      </xacro:if>
      <xacro:if value="${right_finger_scale == 'default'}">
        <xacro:property name="right_finger_scale" value="1.0 1.0 1.0" />
      </xacro:if>

      <link name="${prefix}hand_e_base_link">
          <inertial>
            <origin rpy="0 0 0" xyz="0 0 0.04607"/>
            <mass value="0.86387"/>
            <inertia ixx="1017560E-9" ixy="0" ixz="2235E-9" iyy="1028041E-9" iyz="0" izz="489810E-9"/>
          </inertial>
          <visual>
              <origin rpy="0 0 0" xyz="0 0 0"/>
              <geometry>
                  <mesh filename="${file_path}/meshes/visual/hande/hand-e.dae" scale="1.0 1.0 1.0"/>
              </geometry>
              <material name="dark" />
          </visual>
          <collision>
              <origin rpy="0 0 0" xyz="0 0 0"/>
              <geometry>
                  <mesh filename="${file_path}/meshes/collision/hande/hand-e.stl" scale="1.0 1.0 1.0"/>
              </geometry>
          </collision>
      </link>
      <joint name="${prefix}robotiq_hande_base_joint" type="fixed">
          <parent link="${parent}"/>
          <child link="${prefix}hand_e_base_link"/>
          <xacro:insert_block name="origin"/>
      </joint>

      <!-- Fingers -->
      <link name="${prefix}hande_left_finger">
          <visual>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
              <mesh filename="${left_finger_visual}" scale="${left_finger_scale}" />
            </geometry>
            <material name="gray">
              <color rgba="0.7 0.7 0.7 1.0"/>
            </material>
          </visual>
          <collision>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
              <mesh filename="${left_finger_collision}" scale="${left_finger_scale}" />
            </geometry>
          </collision>
        </link>
        <link name="${prefix}hande_right_finger">
          <visual>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
              <mesh filename="${right_finger_visual}" scale="${right_finger_scale}" />
            </geometry>
            <material name="gray">
              <color rgba="0.7 0.7 0.7 1.0"/>
            </material>
          </visual>
          <collision>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
              <mesh filename="${right_finger_collision}" scale="${right_finger_scale}" />
            </geometry>
          </collision>
      </link>
      <!-- virtual joint to model values coming from the gripper to the geometry - gripper uses
      distance between fingers as command and state values -->
      <link name="${prefix}hande_finger_distance_link" />
      <joint name="${prefix}hande_finger_distance" type="prismatic">
        <axis xyz="1 0 0"/>
        <parent link="${prefix}hand_e_base_link"/>
        <child link="${prefix}hande_finger_distance_link"/>
        <origin rpy="0 0 0" xyz="0 0 0.099"/>
        <axis xyz="1 0 0"/>
        <limit effort="180" lower="0.0" upper="${gripper_maximal_stroke}" velocity="0.15"/>
      </joint>
      <joint name="${prefix}hande_left_finger_joint" type="prismatic">
        <origin rpy="0 0 0" xyz="0 0 0.099"/>
        <parent link="${prefix}hand_e_base_link"/>
        <child link="${prefix}hande_left_finger"/>
        <axis xyz="-1 0 0"/>
        <limit effort="180" lower="0" upper="${gripper_maximal_stroke/2}" velocity="0.15"/>
        <mimic joint="${prefix}hande_finger_distance" multiplier="-0.5" offset="${gripper_maximal_stroke/2}"/>
      </joint>
      <joint name="${prefix}hande_right_finger_joint" type="prismatic">
        <origin rpy="0 0 0" xyz="0 0 0.099"/>
        <parent link="${prefix}hand_e_base_link"/>
        <child link="${prefix}hande_right_finger"/>
        <axis xyz="1 0 0"/>
        <limit effort="180" lower="0" upper="${gripper_maximal_stroke/2}" velocity="0.15"/>
        <mimic joint="${prefix}hande_finger_distance" multiplier="-0.5" offset="${gripper_maximal_stroke/2}"/>
      </joint>

      <link name="$(arg prefix)tcp_link"/>
      <joint name="$(arg prefix)tcp_link_joint" type="fixed">
        <origin xyz="0 0 ${tcp_z_offset}" rpy="0 0 ${-pi/2}"/>
        <parent link="$(arg prefix)hand_e_base_link"/>
        <child link="$(arg prefix)tcp_link"/>
      </joint>

    </xacro:macro>
</robot>
